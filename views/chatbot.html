<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Support - English Learning Center</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/chatbot.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <script src="js/components/common.js"></script>
    <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize user profile
            if (ELC.isAuthenticated()) {
                ELC.initUserProfile();
            } else {
                window.location.href = 'login.html';
            }
            
            // Set up dashboard link based on user role
            const dashboardLink = document.getElementById('dashboard-link');
            if (dashboardLink) {
                const user = ELC.getCurrentUser();
                if (user) {
                    switch (user.role) {
                        case 'student':
                            dashboardLink.href = 'student.html';
                            break;
                    }
                }
            }
            
            // Initialize chatbot functionality
            const messagesContainer = document.getElementById('chatbot-messages');
            const messageInput = document.getElementById('message-input');
            const sendButton = document.getElementById('send-message');
            
            // Load chat history
            loadChatHistory();
            
            // Send message function
            function sendMessage() {
                const message = messageInput.value.trim();
                if (!message) return;
                
                // Add user message to the chat
                addMessage(message, true);
                
                // Clear input
                messageInput.value = '';
                
                // Scroll to bottom of chat
                scrollToBottom();
                
                // Process the message
                processMessage(message);
            }
            
            // Send message when button is clicked
            sendButton.addEventListener('click', sendMessage);
            
            // Send message when Enter key is pressed
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Add message to chat
            function addMessage(message, isUser = false) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isUser ? 'message-user' : 'message-bot'}`;
                messageElement.textContent = message;
                messagesContainer.appendChild(messageElement);
                
                // Save message to API
                saveChatMessage(message, isUser);
                
                // Scroll to bottom of chat
                scrollToBottom();
            }
            
            // Process message and get bot response
            async function processMessage(message) {
                try {
                    const user = ELC.getCurrentUser();
                    if (!user) return;
                    
                    // Show typing indicator
                    const typingIndicator = document.createElement('div');
                    typingIndicator.className = 'message message-bot typing-indicator';
                    typingIndicator.innerHTML = '<span>.</span><span>.</span><span>.</span>';
                    messagesContainer.appendChild(typingIndicator);
                    scrollToBottom();
                    
                    // Call API to process message
                    const response = await ELC.apiRequest(`/chatbot/process/${user._id}`, 'POST', { message });
                    
                    // Remove typing indicator
                    messagesContainer.removeChild(typingIndicator);
                    
                    // Add bot response
                    if (response.success) {
                        addMessage(response.data.message, false);
                    } else {
                        addMessage('Sorry, I encountered an error processing your message. Please try again.', false);
                    }
                } catch (error) {
                    console.error('Error processing message:', error);
                    // Remove typing indicator if there's an error
                    const typingIndicator = document.querySelector('.typing-indicator');
                    if (typingIndicator) {
                        messagesContainer.removeChild(typingIndicator);
                    }
                    addMessage('Sorry, I encountered an error. Please try again later.', false);
                }
            }
            
            // Save chat message to API
            async function saveChatMessage(message, isUserMessage) {
                try {
                    const user = ELC.getCurrentUser();
                    if (!user) return;
                    
                    await ELC.apiRequest(`/chatbot/message/${user._id}`, 'POST', {
                        message,
                        isUserMessage
                    });
                } catch (error) {
                    console.error('Error saving chat message:', error);
                }
            }
            
            // Load chat history from API
            async function loadChatHistory() {
                try {
                    const user = ELC.getCurrentUser();
                    if (!user) return;
                    
                    const response = await ELC.apiRequest(`/chatbot/history/${user._id}`);
                    
                    // Clear existing messages except the first greeting
                    while (messagesContainer.childNodes.length > 1) {
                        messagesContainer.removeChild(messagesContainer.lastChild);
                    }
                    
                    // Add messages from history
                    if (response.success && response.data.length > 0) {
                        response.data.forEach(msg => {
                            const messageElement = document.createElement('div');
                            messageElement.className = `message ${msg.isUserMessage ? 'message-user' : 'message-bot'}`;
                            messageElement.textContent = msg.message;
                            messagesContainer.appendChild(messageElement);
                        });
                        
                        // Scroll to bottom of chat
                        scrollToBottom();
                    }
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }
            
            // Scroll to bottom of chat
            function scrollToBottom() {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // Quick link buttons
            const quickLinkButtons = document.querySelectorAll('.quick-link-btn');
            quickLinkButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const message = this.getAttribute('data-message');
                    messageInput.value = message;
                    sendMessage();
                });
            });
            
            // Load FAQs from API
            async function loadFAQs() {
                try {
                    const response = await ELC.apiRequest('/chatbot/faq', 'GET', null, false);
                    
                    if (response.success && response.data.length > 0) {
                        const faqContent = document.getElementById('faq-content');
                        faqContent.innerHTML = '';
                        
                        response.data.forEach(faq => {
                            const faqItem = document.createElement('div');
                            faqItem.className = 'faq-item';
                            faqItem.innerHTML = `
                                <h4>${faq.question}</h4>
                                <p>${faq.answer}</p>
                            `;
                            faqContent.appendChild(faqItem);
                        });
                    }
                } catch (error) {
                    console.error('Error loading FAQs:', error);
                }
            }
            
            // Load FAQs
            loadFAQs();
        });
    </script>
</body>
</html>